---
// src/pages/cover-letter/[lens].astro
import ResumeLayout from "../../layouts/ResumeLayout.astro";

import { resumeCore } from "../../data/resume/core";
import { resumeLenses } from "../../data/resume/lenses";
import { getCoverLetter } from "../../data/cover-letter/core";

export async function getStaticPaths() {
  return resumeLenses.map((l) => ({
    params: { lens: l.id },
  }));
}

const { lens: lensId } = Astro.params;

const lens = resumeLenses.find((l) => l.id === lensId);
if (!lens) throw new Error(`Resume lens not found: ${lensId}`);

const q = Astro.url.searchParams;

const companyName = q.get("company") ?? "[Company Name]";
const positionTitle = q.get("title") ?? "[Position Title]";
const hiringManagerName = q.get("hm") ?? undefined;
const companyLocationLine = q.get("loc") ?? undefined;
const companyFocus = q.get("focus") ?? undefined;

const keywords = (q.get("kw") ?? "")
  .split(",")
  .map((s) => s.trim())
  .filter(Boolean);

const date =
  q.get("date") ??
  new Date().toLocaleDateString("en-CA", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });

const { subject, body } = getCoverLetter(lens.id, {
  date,
  companyName,
  positionTitle,
  hiringManagerName,
  companyLocationLine,
  companyFocus,
  keywords,
});

// Split into visual paragraphs
const paragraphs = body.split("\n\n");
---

<ResumeLayout title={`Cover Letter — ${lens.label}`} mode="web">
  <div class="resume__toggle">
    <a href={`/cover-letter/${lens.id}/print${Astro.url.search}`}>Switch to PDF view</a>
    <span> · </span>
    <a href={`/resume/${lens.id}`}>View resume</a>
  </div>

  <article class="cover-letter">
    {paragraphs.map((p) => <p>{p}</p>)}
  </article>
</ResumeLayout>

<style>
  .cover-letter {
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .cover-letter p {
    margin-bottom: 1rem;
  }
</style>
